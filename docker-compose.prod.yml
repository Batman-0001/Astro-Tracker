# ═══════════════════════════════════════════════════════════
#  Astral NEO Tracker — Production Docker Compose
# ═══════════════════════════════════════════════════════════
#
#  Usage:
#    1. Copy .env.example to .env and fill in values
#    2. docker compose -f docker-compose.prod.yml up -d --build
#    3. Open http://your-server-ip in browser
#
#  Stop:
#    docker compose -f docker-compose.prod.yml down
#
#  View logs:
#    docker compose -f docker-compose.prod.yml logs -f
# ═══════════════════════════════════════════════════════════

services:
  # ─── MongoDB Database ──────────────────────────────────────
  mongodb:
    image: mongo:7
    container_name: astral-mongodb-prod
    restart: always
    command: ["mongod", "--auth", "--bind_ip_all"]
    environment:
      MONGO_INITDB_ROOT_USERNAME: astral_admin
      MONGO_INITDB_ROOT_PASSWORD: astral_secret_2024
      MONGO_INITDB_DATABASE: astral_neo
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d:ro
    networks:
      - astral-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ─── Backend API ───────────────────────────────────────────
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: astral-backend
    restart: always
    expose:
      - "5000"
    environment:
      NODE_ENV: production
      PORT: 5000
      MONGODB_URI: ${MONGODB_URI:-mongodb://astral_admin:astral_secret_2024@mongodb:27017/astral_neo?authSource=admin}
      JWT_SECRET: ${JWT_SECRET:-astral_jwt_secret_change_in_production}
      NASA_API_KEY: ${NASA_API_KEY:-DEMO_KEY}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost}
    depends_on:
      - mongodb
    networks:
      - astral-network
    deploy:
      resources:
        limits:
          memory: 512M

  # ─── Frontend (nginx + Vite build) ─────────────────────────
  frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ""
        VITE_SOCKET_URL: ""
    container_name: astral-frontend
    restart: always
    ports:
      - "${APP_PORT:-80}:80"
    depends_on:
      - backend
    networks:
      - astral-network
    deploy:
      resources:
        limits:
          memory: 128M

networks:
  astral-network:
    driver: bridge

volumes:
  mongodb_data:
